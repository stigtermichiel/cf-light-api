#!/usr/bin/env ruby

$stdout.sync = true

puts '[cf_light_api] Starting CF Light API and worker...'

require_relative '../lib/cf_light_api/worker.rb'
require_relative '../lib/cf_light_api/scheduler.rb'
logger = Logger.new(STDOUT)
logger.formatter = proc do |_, datetime, _, msg|
  "#{datetime} [cf_light_api:worker]: #{msg}\n"
end

environment_checker = EnvironmentChecker.new(Logger.new(STDOUT))
environment_checker.check_cf_env
environment_checker.check_redis_env
environment_checker.check_new_relic_env
@graphite = environment_checker.check_graphite_env

redis = Redis.new(:uri => ENV['REDIS_URI'])
worker = CFLightAPIWorker.new(redis, @graphite, Redlock::Client.new([redis]), logger)

Scheduler.new(Proc.new {|client| worker.update_cf_data(client)}, Logger.new(STDOUT))

require 'sinatra'
require 'sinatra/cf_light_api'

set :traps, false
set :run, true



